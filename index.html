<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Neural Network Diagram</title>

    <!-- 1. Add Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 2. Add Fonts (Inter for main, Space Mono for panel) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Mono&display=swap" rel="stylesheet">

    <!-- 3. Configure Tailwind to use ShadCN theme colors and fonts -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['Space Mono', 'monospace'],
                    },
                    colors: {
                        border: 'hsl(var(--border))',
                        input: 'hsl(var(--input))',
                        ring: 'hsl(var(--ring))',
                        background: 'hsl(var(--background))',
                        foreground: 'hsl(var(--foreground))',
                        primary: {
                            DEFAULT: 'hsl(var(--primary))',
                            foreground: 'hsl(var(--primary-foreground))',
                        },
                        secondary: {
                            DEFAULT: 'hsl(var(--secondary))',
                            foreground: 'hsl(var(--secondary-foreground))',
                        },
                        destructive: {
                            DEFAULT: 'hsl(var(--destructive))',
                            foreground: 'hsl(var(--destructive-foreground))',
                        },
                        muted: {
                            DEFAULT: 'hsl(var(--muted))',
                            foreground: 'hsl(var(--muted-foreground))',
                        },
                        accent: {
                            DEFAULT: 'hsl(var(--accent))',
                            foreground: 'hsl(var(--accent-foreground))',
                        },
                        popover: {
                            DEFAULT: 'hsl(var(--popover))',
                            foreground: 'hsl(var(--popover-foreground))',
                        },
                        card: {
                            DEFAULT: 'hsl(var(--card))',
                            foreground: 'hsl(var(--card-foreground))',
                        },
                    },
                    borderRadius: {
                        lg: 'var(--radius)',
                        md: 'calc(var(--radius) - 2px)',
                        sm: 'calc(var(--radius) - 4px)',
                    },
                },
            },
        };
    </script>

    <!-- 4. Define ShadCN CSS Variables (Light Theme) AND Legend Styles -->
    <style>
        :root {
            --background: 0 0% 100%;
            --foreground: 222.2 84% 4.9%;
            --card: 0 0% 100%;
            --card-foreground: 222.2 84% 4.9%;
            --popover: 0 0% 100%;
            --popover-foreground: 222.2 84% 4.9%;
            --primary: 222.2 47.4% 11.2%;
            --primary-foreground: 210 40% 98%;
            --secondary: 210 40% 96.1%;
            --secondary-foreground: 222.2 47.4% 11.2%;
            --muted: 210 40% 96.1%;
            --muted-foreground: 215.4 16.3% 46.9%;
            --accent: 210 40% 96.1%;
            --accent-foreground: 222.2 47.4% 11.2%;
            --destructive: 0 84.2% 60.2%;
            --destructive-foreground: 210 40% 98%;
            --border: 214.3 31.8% 91.4%;
            --input: 214.3 31.8% 91.4%;
            --ring: 222.2 84% 4.9%;
            --radius: 0.5rem;
        }
        
        /* Remove default number input spinners */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        /* Basic styling for the 3D canvas labels */
        .label {
            color: #111;
            font-size: 12px;
            background: rgba(255, 255, 255, 0.75);
            padding: 2px 5px;
            border-radius: 4px;
            border: 1px solid #ddd;
            white-space: nowrap;
            pointer-events: none;
            user-select: none;
            /* Font-family will be set by JS */
        }

        /* --- MODIFIED: Added old legend styles back --- */
        .legend {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.85);
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #ccc;
            z-index: 100;
            font-size: 13px;
            /* MODIFIED: Removed hard-coded font-family, will be set by JS */
            /* font-family: 'Inter', sans-serif; */
        }
        .legend h4 {
            margin: 0 0 8px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid #ddd;
            font-weight: 600; /* Added for clarity */
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .legend-color-box {
            width: 14px;
            height: 14px;
            margin-right: 8px;
            border: 1px solid #555;
            flex-shrink: 0;
        }
        .legend-item:last-child {
            margin-bottom: 0;
        }
        /* --- End of Legend Styles --- */

    </style>
</head>
<body class="bg-background text-foreground font-sans antialiased">

    <!-- MODIFIED: Reverted Legend HTML -->
    <div id="legend" class="legend">
        <h4>Layer Key</h4>
        <!-- Items added by JS -->
    </div>

    <!-- ShadCN-style Edit Button (Button) -->
    <button id="show-edit-panel-btn" class="absolute bottom-6 left-6 z-10 h-12 w-12 rounded-full shadow-lg bg-primary text-primary-foreground hover:bg-primary/90 flex items-center justify-center transition-colors" title="Edit Model">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path>
            <circle cx="12" cy="12" r="3"></circle>
        </svg>
    </button>

    <!-- ShadCN-style Edit Panel Overlay (Dialog/Modal) -->
    <div id="edit-panel-overlay" class="fixed inset-0 z-50 bg-black/60 items-center justify-center p-4 hidden">
        <!-- Panel (Card) -->
        <div class="border bg-card text-card-foreground rounded-lg shadow-lg w-full max-w-4xl max-h-[90vh] flex flex-col font-mono">
            
            <!-- Panel Header -->
            <div class="p-6 pb-4 border-b">
                <h3 class="text-xl font-semibold">Edit Model</h3>
            </div>

            <!-- Panel Content (Scrollable) -->
            <div class="p-6 space-y-6 overflow-y-auto">
                
                <!-- General Settings -->
                <div class="space-y-4">
                    <h4 class="text-lg font-medium">General Settings</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Font Picker -->
                        <div class="flex flex-col space-y-2">
                            <label for="font-picker" class="text-sm font-medium">Font</label>
                            <select id="font-picker" class="h-10 w-full border border-input bg-background rounded-md px-3 py-2 text-sm ring-offset-background focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2">
                                <!-- Options added by JS -->
                            </select>
                        </div>
                        <!-- Label Font Size -->
                        <div class="flex flex-col space-y-2">
                            <div class="flex justify-between items-center">
                                <label for="font-size" class="text-sm font-medium">Label Font Size</label>
                                <span class="text-sm text-muted-foreground"><span id="font-size-value">12</span>px</span>
                            </div>
                            <input type="range" id="font-size" name="font-size" min="8" max="24" step="1" value="12" class="w-full h-2 bg-muted rounded-lg appearance-none cursor-pointer [&::-webkit-slider-thumb]:h-5 [&::-webkit-slider-thumb]:w-5 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-primary">
                        </div>
                        <!-- Label Distance -->
                        <div class="flex flex-col space-y-2">
                            <div class="flex justify-between items-center">
                                <label for="label-distance" class="text-sm font-medium">Label Distance</label>
                                <span id="label-distance-value" class="text-sm text-muted-foreground">3.0</span>
                            </div>
                            <input type="range" id="label-distance" name="label-distance" min="1" max="10" step="0.1" value="3.0" class="w-full h-2 bg-muted rounded-lg appearance-none cursor-pointer [&::-webkit-slider-thumb]:h-5 [&::-webkit-slider-thumb]:w-5 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-primary">
                        </div>
                        <!-- Cube Gap -->
                        <div class="flex flex-col space-y-2">
                            <div class="flex justify-between items-center">
                                <label for="cube-gap" class="text-sm font-medium">Cube Gap</label>
                                <span id="cube-gap-value" class="text-sm text-muted-foreground">2.0</span>
                            </div>
                            <input type="range" id="cube-gap" name="cube-gap" min="0" max="20" step="0.5" value="2.0" class="w-full h-2 bg-muted rounded-lg appearance-none cursor-pointer [&::-webkit-slider-thumb]:h-5 [&::-webkit-slider-thumb]:w-5 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-primary">
                        </div>
                        <!-- Block Opacity -->
                        <div class="flex flex-col space-y-2">
                            <div class="flex justify-between items-center">
                                <label for="block-opacity" class="text-sm font-medium">Block Opacity</label>
                                <span id="block-opacity-value" class="text-sm text-muted-foreground">0.85</span>
                            </div>
                            <input type="range" id="block-opacity" name="block-opacity" min="0" max="1" step="0.05" value="0.85" class="w-full h-2 bg-muted rounded-lg appearance-none cursor-pointer [&::-webkit-slider-thumb]:h-5 [&::-webkit-slider-thumb]:w-5 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-primary">
                        </div>
                    </div>
                </div>

                <!-- Edit Legend Key (Table) -->
                <div class="space-y-4">
                    <h4 class="text-lg font-medium">Edit Legend Key</h4>
                    <div class="border rounded-lg">
                        <!-- Legend Header -->
                        <div class="flex p-3 bg-muted/50 border-b">
                            <span class="flex-[3] text-sm font-medium text-muted-foreground px-2">Type Name</span>
                            <span class="flex-[1] text-sm font-medium text-muted-foreground px-2">Color</span>
                            <span class="w-9 h-1 px-2"></span> <!-- Spacer for remove button -->
                        </div>
                        <!-- Legend List -->
                        <div id="legend-list" class="divide-y divide-border">
                            <!-- JS-injected rows go here -->
                        </div>
                    </div>
                    <button id="add-type-btn" class="h-10 px-4 py-2 bg-secondary text-secondary-foreground hover:bg-secondary/80 rounded-md text-sm font-medium transition-colors">Add Type</button>
                </div>

                <!-- Edit Layers (Table) -->
                <div class="space-y-4">
                    <h4 class="text-lg font-medium">Edit Layers</h4>
                    <div class="border rounded-lg">
                        <!-- Layers Header -->
                        <div class="flex p-3 bg-muted/50 border-b text-sm font-medium text-muted-foreground">
                            <span class="px-2" style="flex: 3;">Layer Name</span>
                            <span class="px-2" style="flex: 1;">H</span>
                            <span class="px-2" style="flex: 1;">W</span>
                            <span class="px-2" style="flex: 1;">C</span>
                            <span class="px-2" style="width: 44px;">Color</span>
                            <span class="px-2" style="width: 36px;"></span> <!-- Spacer -->
                        </div>
                        <!-- Layers List -->
                        <div id="layer-list" class="divide-y divide-border">
                            <!-- JS-injected rows go here -->
                        </div>
                    </div>
                    <button id="add-layer-btn" class="h-10 px-4 py-2 bg-secondary text-secondary-foreground hover:bg-secondary/80 rounded-md text-sm font-medium transition-colors">Add Layer</button>
                </div>

            </div>

            <!-- Panel Footer -->
            <div class="p-6 pt-4 border-t flex justify-between items-center">
                <button id="close-panel-btn" class="h-10 px-4 py-2 bg-background border border-input hover:bg-accent hover:text-accent-foreground rounded-md text-sm font-medium transition-colors">Close</button>
                <button id="update-network-btn" class="h-10 px-4 py-2 bg-primary text-primary-foreground hover:bg-primary/90 rounded-md text-sm font-medium transition-colors">Update Visualization</button>
            </div>

        </div>
    </div>


    <!-- 5. Importmap and Three.js script (unchanged) -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.165.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.165.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { CSS2DRenderer, CSS2DObject } from 'three/addons/renderers/CSS2DRenderer.js';

        let layerData = [
            { name: 'Input (x)', H: 180, W: 320, C: 2 },
            { name: 'Initial Max Pool', H: 45, W: 80, C: 1 },
            { name: 'self.conv1', H: 42, W: 77, C: 8 },
            { name: 'Post-Conv1 Max Pool', H: 21, W: 38, C: 8 },
            { name: 'self.lif1', H: 21, W: 38, C: 8 },
            { name: 'self.conv2', H: 18, W: 35, C: 16 },
            { name: 'Post-Conv2 Max Pool', H: 9, W: 17, C: 16 },
            { name: 'self.lif2', H: 9, W: 17, C: 16 },
            { name: 'Flatten', H: 1, W: 1, C: 2448 },
            { name: 'self.fc1', H: 1, W: 1, C: 1 },
            { name: 'self.lif3', H: 1, W: 1, C: 1 }
        ];

        let scene, camera, renderer, controls;
        let labelRenderer; 
        const networkGroup = new THREE.Group();
        let totalZLength = 0;
        
        let gap = 2; 
        let labelDistance = 3.0;
        let labelFontSize = 12;
        let blockOpacity = 0.85;

        const frustumSize = 100;
        const showNameLabels = true; 

        // MODIFIED: Make colorMap mutable
        let colorMap = {
            'Input': 0x4285F4,
            'Pool': 0xDB4437,
            'Conv': 0xF4B400,
            'LIF': 0x0F9D58,
            'Flatten': 0xAB47BC,
            'FC': 0xFF6D00,
        };
        const defaultColor = 0xAAAAAA;

        function getLayerType(name) {
            const lowerName = name.toLowerCase();
            // Check against colorMap keys first
            for (const typeName in colorMap) {
                if (lowerName.includes(typeName.toLowerCase())) {
                    return typeName;
                }
            }
            // Fallback checks
            if (lowerName.includes('input')) return 'Input';
            if (lowerName.includes('pool')) return 'Pool';
            if (lowerName.includes('conv')) return 'Conv';
            if (lowerName.includes('lif')) return 'LIF';
            if (lowerName.includes('flatten')) return 'Flatten';
            if (lowerName.includes('fc')) return 'FC';
            return 'Default';
        }

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xffffff);

            const aspect = window.innerWidth / window.innerHeight;
            camera = new THREE.OrthographicCamera(
                -frustumSize * aspect / 2,
                 frustumSize * aspect / 2,
                 frustumSize / 2,
                -frustumSize / 2,
                 0.1,
                 2000
            );
            
            camera.position.set(50, 50, 50);
            camera.zoom = 1.0;
            camera.updateProjectionMatrix();

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);

            labelRenderer = new CSS2DRenderer();
            labelRenderer.setSize(window.innerWidth, window.innerHeight);
            labelRenderer.domElement.style.position = 'absolute';
            labelRenderer.domElement.style.top = '0px';
            labelRenderer.domElement.style.pointerEvents = 'none'; 
            document.body.appendChild(labelRenderer.domElement);

            const ambientLight = new THREE.AmbientLight(0xcccccc, 1.2);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1.5);
            directionalLight.position.set(1, 1, 0.5);
            scene.add(directionalLight);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.mouseButtons.LEFT = THREE.MOUSE.ROTATE;
            controls.mouseButtons.RIGHT = THREE.MOUSE.PAN;

            // MODIFICATION: Call setupFontPicker *before* createNetwork
            // so the labels are created with the correct initial font.
            setupFontPicker();
            createNetwork();
            createLegend(); 
            setupEditPanelListeners();
            // setupFontPicker(); // Moved up

            const centerZ = totalZLength / 2;
            camera.lookAt(0, 0, centerZ);
            controls.target.set(0, 0, centerZ);
            camera.position.set(40, 40, 40 + centerZ);
            controls.update();

            window.addEventListener('resize', onWindowResize);
        }

        function createLegend() {
            const legend = document.getElementById('legend');
            // Clear everything except the title
            const items = legend.querySelectorAll('.legend-item'); // MODIFIED: Select old class
            items.forEach(item => item.remove());

            const addedTypes = new Set();
            for (const layerType in colorMap) {
                if (!addedTypes.has(layerType)) {
                    const color = colorMap[layerType];
                    const hexColor = '#' + new THREE.Color(color).getHexString();

                    // MODIFIED: Use original class names
                    const item = document.createElement('div');
                    item.className = 'legend-item';
                    
                    const colorBox = document.createElement('div');
                    colorBox.className = 'legend-color-box';
                    colorBox.style.backgroundColor = hexColor;
                    
                    const text = document.createElement('span');
                    text.textContent = layerType;
                    
                    item.appendChild(colorBox);
                    item.appendChild(text);
                    legend.appendChild(item);
                    
                    addedTypes.add(layerType);
                }
            }
        }

        function createNetwork() {
            let currentZ = 0;
            const outlineMaterial = new THREE.LineBasicMaterial({ color: 0x000000, linewidth: 2 });
            
            const lineOffset = Math.max(0.1, labelDistance - 0.2); 
            
            // Get the current font from the body
            const currentFont = document.body.style.fontFamily || "Times New Roman";

            layerData.forEach((layer, i) => {
                const visual_W = Math.log(layer.W + 1) * 1.5;
                const visual_H = Math.log(layer.H + 1) * 1.5;
                const visual_C = Math.log(layer.C + 1) * 1.5;

                const geometry = new THREE.BoxGeometry(visual_W, visual_H, visual_C);
                
                const layerColor = layer.color !== undefined 
                    ? layer.color 
                    : (colorMap[getLayerType(layer.name)] || defaultColor);
                
                const material = new THREE.MeshLambertMaterial({
                    color: layerColor,
                    transparent: true,
                    opacity: blockOpacity
                });

                const mesh = new THREE.Mesh(geometry, material);
                const meshCenterZ = currentZ + visual_C / 2;
                mesh.position.set(0, 0, meshCenterZ);
                
                networkGroup.add(mesh);

                const edges = new THREE.EdgesGeometry(geometry);
                const line = new THREE.LineSegments(edges, outlineMaterial);
                line.position.copy(mesh.position); 
                networkGroup.add(line);

                // Dimension Label
                const dimLabelDiv = document.createElement('div');
                dimLabelDiv.className = 'label';
                dimLabelDiv.textContent = `${layer.H}x${layer.W}x${layer.C}`;
                dimLabelDiv.style.fontSize = `${labelFontSize}px`;
                dimLabelDiv.style.fontFamily = currentFont; // MODIFIED: Apply current font
                
                const dimLabel = new CSS2DObject(dimLabelDiv);
                dimLabel.position.set(0, -visual_H / 2 - labelDistance, meshCenterZ); 
                networkGroup.add(dimLabel);

                // Callout line for dimension label
                const dimLinePoints = [
                    new THREE.Vector3(0, -visual_H / 2, meshCenterZ),
                    new THREE.Vector3(0, -visual_H / 2 - lineOffset, meshCenterZ)
                ];
                const dimLineGeo = new THREE.BufferGeometry().setFromPoints(dimLinePoints);
                const dimLineMat = new THREE.LineBasicMaterial({ color: 0x555555, linewidth: 1 });
                const dimLine = new THREE.Line(dimLineGeo, dimLineMat);
                networkGroup.add(dimLine);

                // Name Label
                if (showNameLabels) {
                    const nameLabelDiv = document.createElement('div');
                    nameLabelDiv.className = 'label';
                    nameLabelDiv.textContent = layer.name;
                    nameLabelDiv.style.fontSize = `${labelFontSize}px`;
                    nameLabelDiv.style.fontFamily = currentFont; // MODIFIED: Apply current font
                    
                    const nameLabel = new CSS2DObject(nameLabelDiv);
                    nameLabel.position.set(0, visual_H / 2 + labelDistance, meshCenterZ); 
                    networkGroup.add(nameLabel);

                    // Callout line for name label
                    const nameLinePoints = [
                        new THREE.Vector3(0, visual_H / 2, meshCenterZ),
                        new THREE.Vector3(0, visual_H / 2 + lineOffset, meshCenterZ)
                    ];
                    const nameLineGeo = new THREE.BufferGeometry().setFromPoints(nameLinePoints);
                    const nameLineMat = new THREE.LineBasicMaterial({ color: 0x555555, linewidth: 1 });
                    const nameLine = new THREE.Line(nameLineGeo, nameLineMat);
                    networkGroup.add(nameLine);
                }

                // Connector lines
                if (i > 0) {
                    const prevLayer = layerData[i-1];
                    const prev_visual_C = Math.log(prevLayer.C + 1) * 1.5;
                    const prevLayerZEnd = currentZ - gap;
                    const prevLayerCenterZ = prevLayerZEnd - prev_visual_C / 2;

                    const points = [
                        new THREE.Vector3(0, 0, prevLayerCenterZ + prev_visual_C / 2),
                        new THREE.Vector3(0, 0, meshCenterZ - visual_C / 2)
                    ];
                    const lineGeo = new THREE.BufferGeometry().setFromPoints(points);
                    const lineMat = new THREE.LineBasicMaterial({ color: 0x555555, linewidth: 1 });
                    const connector = new THREE.Line(lineGeo, lineMat);
                    networkGroup.add(connector);
                }

                currentZ += visual_C + gap;
            });

            scene.add(networkGroup);
            totalZLength = currentZ - gap;
        }

        // --- Functions for Edit Panel ---
        
        // --- MODIFICATION: NEW FUNCTION ---
        /**
         * Updates the font-family for the body, legend, and all 3D labels.
         * @param {string} fontFamily - The CSS font-family string (e.g., "Arial")
         */
        function updateGlobalFont(fontFamily) {
            // 1. Change main body font
            document.body.style.fontFamily = fontFamily;
            
            // 2. Keep the edit panel font as 'Space Mono'
            const monoPanel = document.querySelector('.font-mono');
            if (monoPanel) {
                monoPanel.style.fontFamily = 'Space Mono, monospace';
            }
            
            // 3. Re-apply font to the legend
            const legend = document.getElementById('legend');
            if (legend) {
                legend.style.fontFamily = fontFamily;
            }
            
            // 4. Re-apply font to all existing 3D labels
            document.querySelectorAll('.label').forEach(label => {
                label.style.fontFamily = fontFamily;
            });
        }
        // --- END OF NEW FUNCTION ---

        function setupFontPicker() {
            const fonts = ["Times New Roman", "Arial", "Courier New", "Georgia", "Verdana"];
            const fontPicker = document.getElementById('font-picker');
            
            fontPicker.innerHTML = ''; 
            const defaultFont = "Times New Roman";

            // MODIFIED: Set initial font for body, legend, and labels
            updateGlobalFont(defaultFont); 

            fonts.forEach(font => {
                const option = document.createElement('option');
                option.value = font;
                option.textContent = font;
                if (font === defaultFont) {
                    option.selected = true;
                }
                fontPicker.appendChild(option);
            });

            // MODIFIED: Use the new function on change
            fontPicker.addEventListener('change', (e) => {
                updateGlobalFont(e.target.value);
            });
        }

        function setupEditPanelListeners() {
            const overlay = document.getElementById('edit-panel-overlay');
            const showBtn = document.getElementById('show-edit-panel-btn');
            const closeBtn = document.getElementById('close-panel-btn');
            const updateBtn = document.getElementById('update-network-btn');
            const addLayerBtn = document.getElementById('add-layer-btn');
            const addTypeBtn = document.getElementById('add-type-btn'); // ADDED
            
            const labelSlider = document.getElementById('label-distance');
            const labelValue = document.getElementById('label-distance-value');
            const gapSlider = document.getElementById('cube-gap');
            const gapValue = document.getElementById('cube-gap-value');
            const fontSizeSlider = document.getElementById('font-size');
            const fontSizeValue = document.getElementById('font-size-value');
            const opacitySlider = document.getElementById('block-opacity');
            const opacityValue = document.getElementById('block-opacity-value');

            showBtn.addEventListener('click', () => {
                populateEditPanel();
                populateLegendPanel(); // ADDED

                labelSlider.value = labelDistance;
                labelValue.textContent = labelDistance.toFixed(1);
                gapSlider.value = gap;
                gapValue.textContent = gap.toFixed(1);
                fontSizeSlider.value = labelFontSize;
                fontSizeValue.textContent = labelFontSize;
                opacitySlider.value = blockOpacity;
                opacityValue.textContent = blockOpacity.toFixed(2);

                overlay.classList.remove('hidden');
                overlay.classList.add('flex'); // Make sure it's flex
            });

            closeBtn.addEventListener('click', () => {
                overlay.classList.add('hidden');
                overlay.classList.remove('flex');
            });

            addLayerBtn.addEventListener('click', () => {
                addLayerRow({ name: 'New Layer', H: 1, W: 1, C: 1 });
            });

            // ADDED
            addTypeBtn.addEventListener('click', () => {
                addLegendRow('NewType', '#aaaaaa');
            });

            updateBtn.addEventListener('click', () => {
                rebuildNetworkFromPanel();
                overlay.classList.add('hidden');
                overlay.classList.remove('flex');
            });

            labelSlider.addEventListener('input', (e) => {
                labelValue.textContent = parseFloat(e.target.value).toFixed(1);
            });
            gapSlider.addEventListener('input', (e) => {
                gapValue.textContent = parseFloat(e.target.value).toFixed(1);
            });
            fontSizeSlider.addEventListener('input', (e) => {
                fontSizeValue.textContent = e.target.value;
            });
            opacitySlider.addEventListener('input', (e) => {
                opacityValue.textContent = parseFloat(e.target.value).toFixed(2);
            });
        }

        function populateEditPanel() {
            const list = document.getElementById('layer-list');
            list.innerHTML = '';
            layerData.forEach(layer => {
                addLayerRow(layer);
            });
        }

        // ADDED: Populate Legend Editor
        function populateLegendPanel() {
            const list = document.getElementById('legend-list');
            list.innerHTML = '';
            for (const typeName in colorMap) {
                const hexColor = '#' + new THREE.Color(colorMap[typeName]).getHexString();
                addLegendRow(typeName, hexColor);
            }
        }

        function addLayerRow(layer) {
            const list = document.getElementById('layer-list');
            const row = document.createElement('div');
            // MODIFIED: Use Tailwind classes for the row
            row.className = 'flex items-center p-2 space-x-2';
            
            const initialColor = layer.color !== undefined 
                ? layer.color 
                : (colorMap[getLayerType(layer.name)] || defaultColor);
            const hexColor = '#' + new THREE.Color(initialColor).getHexString();

            // MODIFIED: Use Tailwind classes for inputs
            row.innerHTML = `
                <input type="text" name="name" value="${layer.name}" class="h-9 border border-input bg-background rounded-md px-3 py-1 text-sm ring-offset-background focus:outline-none focus:ring-2 focus:ring-ring" style="flex: 3;">
                <input type="number" name="H" value="${layer.H}" min="1" class="h-9 border border-input bg-background rounded-md px-3 py-1 text-sm ring-offset-background focus:outline-none focus:ring-2 focus:ring-ring" style="flex: 1;">
                <input type="number" name="W" value="${layer.W}" min="1" class="h-9 border border-input bg-background rounded-md px-3 py-1 text-sm ring-offset-background focus:outline-none focus:ring-2 focus:ring-ring" style="flex: 1;">
                <input type="number" name="C" value="${layer.C}" min="1" class="h-9 border border-input bg-background rounded-md px-3 py-1 text-sm ring-offset-background focus:outline-none focus:ring-2 focus:ring-ring" style="flex: 1;">
                <input type="color" name="color" value="${hexColor}" class="h-9 w-11 p-0 border-none rounded-md cursor-pointer" style="width: 44px;">
                <button class="remove-btn h-9 w-9 p-0 rounded-md bg-destructive text-destructive-foreground hover:bg-destructive/90 flex items-center justify-center transition-colors">
                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                </button>
            `;
            
            row.querySelector('.remove-btn').addEventListener('click', () => {
                row.remove();
            });

            list.appendChild(row);
        }

        // ADDED: Add Legend Row
        function addLegendRow(typeName, hexColor) {
            const list = document.getElementById('legend-list');
            const row = document.createElement('div');
            row.className = 'flex items-center p-2 space-x-2';
            
            row.innerHTML = `
                <input type="text" name="type-name" value="${typeName}" class="h-9 border border-input bg-background rounded-md px-3 py-1 text-sm ring-offset-background focus:outline-none focus:ring-2 focus:ring-ring flex-[3]">
                <input type="color" name="type-color" value="${hexColor}" class="h-9 p-0 border-none rounded-md cursor-pointer flex-[1]">
                <button class="remove-btn h-9 w-9 p-0 rounded-md bg-destructive text-destructive-foreground hover:bg-destructive/90 flex items-center justify-center transition-colors">
                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                </button>
            `;
            
            row.querySelector('.remove-btn').addEventListener('click', () => {
                row.remove();
            });

            list.appendChild(row);
        }

        // ADDED: Rebuild Color Map
        function rebuildColorMapFromPanel() {
            const list = document.getElementById('legend-list');
            const rows = list.querySelectorAll('.flex');
            const newColorMap = {};
            
            rows.forEach(row => {
                const nameInput = row.querySelector('input[name="type-name"]');
                const colorInput = row.querySelector('input[name="type-color"]');
                if (nameInput && colorInput) {
                    const typeName = nameInput.value;
                    const colorHex = colorInput.value;
                    newColorMap[typeName] = new THREE.Color(colorHex).getHex();
                }
            });
            colorMap = newColorMap;
        }

        function rebuildNetworkFromPanel() {
            rebuildColorMapFromPanel(); // ADDED: Rebuild map first

            const list = document.getElementById('layer-list');
            const rows = list.querySelectorAll('.flex'); // Selects the rows
            const newLayerData = [];

            labelDistance = parseFloat(document.getElementById('label-distance').value) || 3.0;
            gap = parseFloat(document.getElementById('cube-gap').value) || 2.0;
            labelFontSize = parseInt(document.getElementById('font-size').value) || 12; 
            blockOpacity = parseFloat(document.getElementById('block-opacity').value);

            rows.forEach(row => {
                const nameInput = row.querySelector('input[name="name"]');
                const hInput = row.querySelector('input[name="H"]');
                const wInput = row.querySelector('input[name="W"]');
                const cInput = row.querySelector('input[name="C"]');
                const colorInput = row.querySelector('input[name="color"]');

                if (nameInput && hInput && wInput && cInput && colorInput) {
                    const name = nameInput.value;
                    const H = parseInt(hInput.value) || 1;
                    const W = parseInt(wInput.value) || 1;
                    const C = parseInt(cInput.value) || 1;
                    const colorHex = colorInput.value;
                    const color = new THREE.Color(colorHex).getHex();
                    newLayerData.push({ name, H, W, C, color });
                }
            });

            layerData = newLayerData;

            // Clear the old network
            while (networkGroup.children.length > 0) {
                const child = networkGroup.children[0];
                networkGroup.remove(child);
                // Dispose geometry and materials if needed, but this is simpler
            }

            // Reset state and rebuild
            totalZLength = 0;
            createNetwork();
            createLegend(); // ADDED: Update legend

            // Recenter camera
            const centerZ = totalZLength / 2;
            camera.lookAt(0, 0, centerZ);
            controls.target.set(0, 0, centerZ);
            camera.position.set(40, 40, 40 + centerZ);
            controls.update();
        }

        function onWindowResize() {
            const aspect = window.innerWidth / window.innerHeight;
            camera.left = -frustumSize * aspect / 2;
            camera.right = frustumSize * aspect / 2;
            camera.top = frustumSize / 2;
            camera.bottom = -frustumSize / 2;
            camera.updateProjectionMatrix();
            
            renderer.setSize(window.innerWidth, window.innerHeight);
            labelRenderer.setSize(window.innerWidth, window.innerHeight); 
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
            labelRenderer.render(scene, camera); 
        }

        init();
        animate();

    </script>
</body>
</html>
